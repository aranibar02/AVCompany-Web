@model AVcompanyWeb.ViewModels.ProductViewModel
@{
    //ViewBag.Title = "Products";
    double igv = Convert.ToDouble(ViewBag.Igv);
}


<div class="row page-titles">
    <div class="col-md-5 align-self-center">
        <span class="icon-puzzle"></span><h4 class="text-themecolor" style="display:inline;padding-left:10px;">Nuevo Producto</h4>
    </div>
    <div class="col-md-7 align-self-center text-right">
        <div class="d-flex justify-content-end align-items-center">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Home</a></li>
                <li class="breadcrumb-item"><a href="@Url.Action("List","Product")">Productos</a></li>
                <li class="breadcrumb-item active">Nuevo</li>
            </ol>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body wizard-content">
                <h4 class="card-title"></h4>
                <h6 class="card-subtitle"></h6>
                <form action="#" class="validation-wizard wizard-circle">
                    </br>
                    <!-- Step 1 -->
                    <h6>Información</h6>
                    <section>
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="white-box">
                                    <div class="form">
                                        <div class="form-group row">
                                            <label for="example-text-input" class="col-2 col-form-label">Código</label>
                                            <div class="col-10">
                                                <input type="text"  class="form-control" id="identifierCode" disabled style="background-color:#fff"/>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="example-search-input" class="col-2 col-form-label">Nombre:</label>
                                            <div class="col-10">
                                                <input type="text" class="form-control required" id="name" name="name"/>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="example-email-input" class="col-2 col-form-label">Categoría:</label>
                                            <div class="col-10">
                                                <select class="custom-select form-control required"  id="categoryId" name="category">
                                                    <option value="" disabled selected>Open this select menu</option>
                                                    @foreach (var item in Model.categories)
                                                    {
                                                        <option value="@item.id">@item.name</option>
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="example-url-input" class="col-2 col-form-label">Sub-Categoría</label>
                                            <div class="col-10">
                                                <select class="custom-select" id="subCategoryId">
                                                    <option value=""  selected>Open this select menu</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="example-tel-input" class="col-2 col-form-label">Tipo de Madera</label>
                                            <div class="col-10">
                                                <select class="custom-select" id="woodTypeId" required name="woodType">
                                                    <option disabled selected>Open this select menu</option>
                                                    @foreach (var item in Model.woodTypes)
                                                    {
                                                        <option value="@item.id">@item.description</option>
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="example-password-input" class="col-2 col-form-label" >Tipo de Acabado</label>
                                            <div class="col-10">
                                                <select class="custom-select"  id="woodProtectionTypeId" required name="woodProtectionType">
                                                    <option value="" disabled selected>Open this select menu</option>
                                                    @foreach (var item in Model.woodProtectionTypes)
                                                    {
                                                        <option value="@item.id">@item.name</option>
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="example-number-input" class="col-2 col-form-label">Ancho</label>
                                            <div class="col-10">
                                                <div class="input-group bootstrap-touchspin bootstrap-touchspin-injected"><input type="number" class="form-control" id="width"  data-bts-button-down-class="btn btn-secondary btn-outline" data-bts-button-up-class="btn btn-secondary btn-outline"/><span class="input-group-addon bootstrap-touchspin-postfix input-group-append"><span class="input-group-text" style="background-color: #4F5467;color: white;">cm</span></span></div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="example-datetime-local-input" class="col-2 col-form-label">Alto</label>
                                            <div class="col-10">
                                                <div class="input-group bootstrap-touchspin bootstrap-touchspin-injected"><input type="number" class="form-control" id="height"  data-bts-button-down-class="btn btn-secondary btn-outline" data-bts-button-up-class="btn btn-secondary btn-outline"/><span class="input-group-addon bootstrap-touchspin-postfix input-group-append"><span class="input-group-text" style="background-color: #4F5467;color: white;">cm</span></span></div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="example-date-input" class="col-2 col-form-label">Profundidad</label>
                                            <div class="col-10">
                                                <div class="input-group bootstrap-touchspin bootstrap-touchspin-injected"><input type="number" class="form-control" id="depth"  data-bts-button-down-class="btn btn-secondary btn-outline" data-bts-button-up-class="btn btn-secondary btn-outline"/><span class="input-group-addon bootstrap-touchspin-postfix input-group-append"><span class="input-group-text" style="background-color: #4F5467;color: white;">cm</span></span></div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="example-month-input" class="col-2 col-form-label">Peso</label>
                                            <div class="col-10">
                                                <div class="input-group bootstrap-touchspin bootstrap-touchspin-injected"><input type="number" class="form-control" id="weight"  data-bts-button-down-class="btn btn-secondary btn-outline" data-bts-button-up-class="btn btn-secondary btn-outline"/><span class="input-group-addon bootstrap-touchspin-postfix input-group-append"><span class="input-group-text" style="background-color: #4F5467;color: white;">gr</span></span></div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="example-week-input" class="col-2 col-form-label">Tiempo de Fabricación</label>
                                            <div class="col-10">
                                                <div class="input-group bootstrap-touchspin bootstrap-touchspin-injected"><input type="number" class="form-control" id="manufacturingTime"  data-bts-button-down-class="btn btn-secondary btn-outline" data-bts-button-up-class="btn btn-secondary btn-outline"/><span class="input-group-addon bootstrap-touchspin-postfix input-group-append"><span class="input-group-text" style="background-color: #4F5467;color: white;">hr</span></span></div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="example-time-input" class="col-2 col-form-label">Exclusividad</label>
                                            <div class="col-10">
                                                <div class="input-group">
                                                    <ul class="icheck-list">
                                                        <li>
                                                            <div class="icheckbox_square-red" style="position: relative;">
                                                                <input type="checkbox"  class="check" id="isExclusive" data-checkbox="icheckbox_square-red" style="position: absolute; opacity: 0;">
                                                                <ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255); border: 0px; opacity: 0;"></ins>
                                                            </div>
                                                           
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="customer-section" class="form-group row" style="display:none">
                                            <label for="example-time-input" class="col-2 col-form-label">Cliente</label>
                                            <div class="col-10">
                                                <select  id="customerId" class="select2 form-control custom-select" style="width: 100%; height:36px;">
                                                    <option selected disabled>Select</option>
                                                    @foreach (var item in Model.customers)
                                                    {
                                                        <option value="@item.Id">@item.companyName</option>
                                                    }
                                                </select>
                                            </div>
                                        </div>                                       
                                        <div class="form-group row">
                                            <label for="example-time-input" class="col-2 col-form-label">Descripción</label>
                                            <div class="col-10">
                                                <textarea name="description" id="description" rows="6" class="form-control"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    <!-- Step 2 -->
                    <h6>Imágenes</h6>
                    <section>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <h4 class="card-title">Dropzone</h4>
                                            <h6 class="card-subtitle">For multiple file upload put class <code>.dropzone</code> to form.</h6>
                                            <div action="#" class="dropzone dz-clickable" id="dropzoneImages">
                                                <input type="file" style="display: none" id="filesUpload" multiple/>
                                                <div class="dz-default dz-message">
                                                    <span>Drop files here to upload</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    <!-- Step 3 -->
                    <h6>Precios</h6>
                    <section>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm table-bordered" style="width:0%;margin:auto">
                                <thead>
                                    <tr>
                                        <th style="text-align:center;background-color:#4F5467;color:white">Tipo de Precio</th>
                                        <th style="text-align:center;background-color:#4F5467;color:white">Sin IGV</th>
                                        <th style="text-align:center;background-color:#4F5467;color:white">Con IGV</th>
                                        <th style="text-align:center;background-color:#4F5467;color:white">Predeterminado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.priceTypes)
                                    {

                                        <tr>
                                            <td style="text-align:center"><label class="price-name">@item.name</label></td>
                                            <td style="text-align:center">
                                                <div class="input-group mb-2">
                                                    <div class="input-group-prepend">
                                                        <span class="input-group-text" style="border-style:hidden;background-color:white">S/.</span>
                                                    </div>
                                                    <input type="text" class="form-control price-input" data-price="@item.id" data-product="@Model.id" aria-label="Amount (to the nearest dollar)" style="border-style:hidden;text-align:center"/>
                                                </div>
                                            </td>
                                            <td style="text-align:center">
                                                <div class="input-group mb-2">
                                                    <div class="input-group-prepend">
                                                        <span class="input-group-text" style="border-style:hidden;background-color:white">S/.</span>
                                                    </div>
                                                    <input type="text" class="form-control price-witout-igv" id="withIGV_@item.id" disabled  data-price="@item.id" data-product="@Model.id" aria-label="Amount (to the nearest dollar)" style="border-style:hidden;text-align:center;background-color:white"/>
                                                </div>
                                            </td>
                                            <td style="text-align:center">                                              
                                                    <input type="checkbox" class="price-default-selection" id="defaultSelection_@item.id"  data-price="@item.id" data-product="@Model.id" />  
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </section>
                    </br>
                </form>
            </div>
        </div>
    </div>
</div>
@section Scripts{
    <script>
        var dropzoneFiles;

        $(document).ready(function () {
            $('.select2').select2();

            Dropzone.forElement(".dropzone").options.autoProcessQueue = false;
            Dropzone.forElement(".dropzone").options.parallelUploads = 30;
            Dropzone.forElement(".dropzone").options.uploadMultiple = true;

            Dropzone.forElement(".dropzone").on("queuecomplete", function (file) {
                console.log("success files");
                window.location = "@Url.Action("List","Product")";
            });

            $('.icheckbox_square-red').hover(function () {
                $(this).addClass('hover');
            })

            $('.icheckbox_square-red').mouseout(function () {
                $(this).removeClass('hover');
            })

            $('.icheckbox_square-red').click(function () {

                if ($(this).hasClass("checked")) {
                    $(this).removeClass('checked');
                    $('#customer-section').css("display","none");
                    $('#isExclusive').val(false);
                } else {
                    $(this).addClass('checked');
                    $('#customer-section').css("display","flex");
                    $('#isExclusive').val(true);
                }

            })


            $('.price-default-selection').change(function(){
                if($(this).is(':checked')){
                    $('.price-default-selection:not(:checked)').attr('disabled',true);
                }
                else{
                    $('.price-default-selection:not(:checked)').attr('disabled',false);
                }
            });



        /*Get SubCategories and identifierCode*/
            $('#categoryId').change(function () {

                var categoryId = $(this).val();

                $.ajax({
                    method: 'get',
                    data: { categoryId : categoryId },
                    url: '@Url.Action("GetSubCategories","Product")',
                    success: function (response) {
                        console.log(response)

                        $('#subCategoryId').empty();
                        $('#subCategoryId').append("<option selected>Open this select menu</option>")
                        $.each(response, function (index, value) {
                            var option = document.createElement("option");
                            console.log(response[index].name);
                            option.text = response[index].name;
                            option.value = response[index].id;
                            $('#subCategoryId').append(option);

                        })
                    }
                })


                $.ajax({
                    method: 'get',
                    data: { categoryId : categoryId },
                    url: '@Url.Action("GetIdentifierCode","Product")',
                    success: function (response) {
                        console.log(response);
                        $('#identifierCode').val(response);
                    }
                })



            });
        /**/
            $(".price-input").change(function () {
                var id = $(this).attr("data-price");
                var amount = $(this).val() * @igv;
                console.log(amount);
                $("#withIGV_" + id).val(Math.round(amount));
            });

        });



        function ProcessProduct() {

            var product = new FormData();

            product.append("name", $('#name').val());
            product.append("identifierCode", $('#identifierCode').val());
            product.append("category", $('#category').val());
            product.append("width", $('#width').val());
            product.append("height", $('#height').val());
            product.append("depth", $('#depth').val());
            product.append("weight", $('#weight').val());
            product.append("manufacturingTime", $('#manufacturingTime').val());
            product.append("description", $('#description').val());
            product.append("woodTypeId", $('#woodTypeId').val());
            product.append("woodProtectionTypeId", $('#woodProtectionTypeId').val());
            product.append("categoryId", $('#categoryId').val());
            product.append("subCategoryId", $('#subCategoryId').val());
            product.append("isExclusive", $('#isExclusive').val());
            product.append("CustomerId",$('#customerId').val());
            product.append("categoryId",$('#categoryId').val());

            var priceProducts = [];

            $.ajax({
                method: 'post',
                processData: false,
                contentType: false,
                cache: false,
                data: product,
                url: '@Url.Action("Save","Product")',
                success: function (data) {
                    console.log(data);

                    $.each($('.price-input'), function (index, value) {
                        priceProducts.push({
                            id: 0,
                            productId: data,
                            priceTypeId: $(this).attr("data-price"),
                            priceWithoutIGV: $(this).val(),
                            priceWithIGV: $(this).val() * @igv,
                            isActive: true,
                            isSelected: $('#defaultSelection_' + $(this).attr("data-price")).is(':checked') ? true : false
                        });
                    });

                    console.log(priceProducts);

                    $.post("@Url.Action("SaveProductPrices","Product")", { productPrices: priceProducts }, function (response) {
                        if (response == "Success") {
                            Dropzone.forElement(".dropzone").processQueue();
                        }
                    });
                }
            });

        };



        var form = $(".validation-wizard").show();

        $(".validation-wizard").steps({
            headerTag: "h6",
            bodyTag: "section",
            transitionEffect: "fade",
            titleTemplate: '<span class="step">#index#</span> #title#',
            labels: {
                finish: "Submit"
            },
            onStepChanging: function (event, currentIndex, newIndex) {
                $(".validation-wizard").validate({

                    ignore: "input[type=hidden]",
                    errorClass: "text-danger",
                    successClass: "text-success",
                    highlight: function (element, errorClass) {
                        $(element).removeClass(errorClass)
                    },
                    unhighlight: function (element, errorClass) {
                        $(element).removeClass(errorClass)
                    },
                    errorPlacement: function (error, element) {
                        error.insertAfter(element)
                    },

                    rules:{
                        name:{required: true},
                        category: {required:true},
                        woodProtectionType: {required:true},
                        woodType:{required:true},
                        description: {required:true}
                    },
                    messages:{
                        name: "Campo obligatorio.",
                        category: "Campo obligatorio.",
                        woodProtectionType: "Campo obligatorio.",
                        woodType: "Campo obligatorio.",
                        description: "Campo obligatorio"
                    },


                    }
                    );
                return  form.valid();
            },
            onFinishing: function (event, currentIndex) {
                return form.validate().settings.ignore = ":disabled", form.valid()
            },
            onFinished: function (event, currentIndex) {
                ProcessProduct()
            }
        });


    </script>
}


